# 7.6 æœ¬ç« å°ç»“

> å›é¡¾ä¸å±•æœ›

æœ¬ç« æˆ‘ä»¬å­¦ä¹ äº† AgentX â€”â€” Deepractice å›¢é˜Ÿå¼€å‘çš„äº‹ä»¶é©±åŠ¨æ™ºèƒ½ä½“æ¡†æ¶ã€‚è®©æˆ‘ä»¬å›é¡¾æ ¸å¿ƒå†…å®¹ï¼Œå¹¶æ£€æŸ¥å­¦ä¹ æˆæœã€‚

---

## 7.6.1 æ ¸å¿ƒæ¦‚å¿µå›é¡¾

### äº‹ä»¶é©±åŠ¨æ¶æ„

AgentX çš„æ ¸å¿ƒè®¾è®¡ç†å¿µæ˜¯**äº‹ä»¶é©±åŠ¨**ï¼š

```
ä¼ ç»Ÿæ¨¡å¼ï¼šrequest â†’ wait â†’ responseï¼ˆåŒæ­¥é˜»å¡ï¼‰
AgentXï¼š  event â†’ process â†’ eventï¼ˆå¼‚æ­¥éé˜»å¡ï¼‰
```

**ä¼˜åŠ¿**ï¼š
- æ¾è€¦åˆï¼šç»„ä»¶é€šè¿‡äº‹ä»¶é€šä¿¡ï¼Œäº’ä¸ä¾èµ–
- å¯è§‚æµ‹ï¼šæ‰€æœ‰äº‹ä»¶å¯è¿½è¸ªã€å¯é‡æ”¾
- å¯æ‰©å±•ï¼šæ·»åŠ æ–°åŠŸèƒ½ä¸å½±å“ç°æœ‰ä»£ç 
- å®æ—¶æ€§ï¼šæµå¼è¾“å‡ºï¼Œå³æ—¶åé¦ˆ

### Mealy Machine æ¨¡å¼

AgentEngine é‡‡ç”¨ Mealy Machine çŠ¶æ€æœºï¼š

```
(state, input) â†’ (state, outputs)

ç¤ºä¾‹ï¼š
(idle, user_message) â†’ (thinking, [thinking_start])
(thinking, llm_chunk) â†’ (thinking, [text_delta])
(thinking, llm_end) â†’ (idle, [thinking_end, message_complete])
```

**ç‰¹ç‚¹**ï¼š
- çº¯å‡½æ•°ï¼šç›¸åŒè¾“å…¥æ€»æ˜¯ç›¸åŒè¾“å‡º
- å¯æµ‹è¯•ï¼šçŠ¶æ€è½¬æ¢å¯å•å…ƒæµ‹è¯•
- å¯é¢„æµ‹ï¼šè¡Œä¸ºå®Œå…¨ç”±çŠ¶æ€å’Œè¾“å…¥å†³å®š

### å››å±‚äº‹ä»¶æ¨¡å‹

| å±‚çº§ | äº‹ä»¶ç±»å‹ | é¢‘ç‡ | ç”¨é€” |
|-----|---------|-----|------|
| **Stream** | text_delta, tool_delta | é«˜ | å®æ—¶æµå¼è¾“å‡º |
| **State** | thinking_start/end, tool_start/end | ä¸­ | çŠ¶æ€å˜åŒ–é€šçŸ¥ |
| **Message** | user_message, assistant_message | ä½ | å®Œæ•´æ¶ˆæ¯è®°å½• |
| **Turn** | turn_complete | æœ€ä½ | è½®æ¬¡ç»Ÿè®¡åˆ†æ |

---

## 7.6.2 æ¶æ„ç»„ä»¶æ€»ç»“

### æ ¸å¿ƒç»„ä»¶

| ç»„ä»¶ | èŒè´£ | å…³é”®æ–¹æ³• |
|-----|------|---------|
| **AgentEngine** | çŠ¶æ€æœºå¼•æ“ | input(), on('output') |
| **SystemBus** | äº‹ä»¶æ€»çº¿ | emit(), on(), filter() |
| **Container** | ç”Ÿå‘½å‘¨æœŸç®¡ç† | register(), create(), destroy() |
| **Environment** | å¤–éƒ¨ç³»ç»Ÿæ¥å£ | llm.chat(), mcp.callTool() |
| **Persistence** | æ•°æ®æŒä¹…åŒ– | saveMessage(), getMessages() |

### Driver/Presenter æ¨¡å¼

```
Driverï¼ˆè¾“å…¥ï¼‰â†’ SystemBusï¼ˆäº‹ä»¶ï¼‰â†’ Presenterï¼ˆè¾“å‡ºï¼‰
```

- **Driver**ï¼šå°†å¤–éƒ¨è¾“å…¥è½¬æ¢ä¸ºäº‹ä»¶ï¼ˆCLIã€HTTPã€WebSocketï¼‰
- **Presenter**ï¼šå°†äº‹ä»¶è½¬æ¢ä¸ºå¯è§è¾“å‡ºï¼ˆç»ˆç«¯ã€React UIï¼‰

---

## 7.6.3 ä¸ PromptX é›†æˆ

### é›†æˆæ–¹å¼

é€šè¿‡ MCP åè®®å°† PromptX ä½œä¸ºå·¥å…·æœåŠ¡å™¨æ¥å…¥ï¼š

```typescript
mcpServers: [
  { name: 'promptx', command: 'npx', args: ['-y', '@promptx/cli'] }
]
```

### è®¤çŸ¥èƒ½åŠ›

| èƒ½åŠ› | PromptX å·¥å…· | ä½œç”¨ |
|-----|-------------|------|
| **è§’è‰²æ¿€æ´»** | action | æ¿€æ´»ä¸“ä¸šè§’è‰²ï¼Œè·å¾—é¢†åŸŸçŸ¥è¯† |
| **å·¥å…·è°ƒç”¨** | toolx | ä½¿ç”¨ Luban åˆ›å»ºçš„å·¥å…· |
| **è®°å¿†æ£€ç´¢** | recall | ä»è®°å¿†ç½‘ç»œè·å–ç›¸å…³ä¿¡æ¯ |
| **è®°å¿†å­˜å‚¨** | remember | ä¿å­˜æ–°çŸ¥è¯†åˆ°è®°å¿†ç½‘ç»œ |
| **èµ„æºå‘ç°** | discover | å‘ç°å¯ç”¨çš„è§’è‰²å’Œå·¥å…· |

### è®¤çŸ¥å¾ªç¯

```
recall â†’ æ€è€ƒ â†’ remember
  â†‘                 â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 7.6.4 å­¦ä¹ æ£€æŸ¥

### æ¦‚å¿µç†è§£

è¯·å°è¯•å›ç­”ä»¥ä¸‹é—®é¢˜ï¼š

1. **ä¸ºä»€ä¹ˆé€‰æ‹©äº‹ä»¶é©±åŠ¨æ¶æ„ï¼Ÿ**
   - ç›¸æ¯”è¯·æ±‚-å“åº”æ¨¡å¼æœ‰ä»€ä¹ˆä¼˜åŠ¿ï¼Ÿ

2. **Mealy Machine çš„æ ¸å¿ƒå…¬å¼æ˜¯ä»€ä¹ˆï¼Ÿ**
   - ä¸ºä»€ä¹ˆè¯´å®ƒæ˜¯"çº¯å‡½æ•°"ï¼Ÿ

3. **å››å±‚äº‹ä»¶æ¨¡å‹ä¸­ï¼Œå“ªä¸€å±‚é¢‘ç‡æœ€é«˜ï¼Ÿ**
   - æ¯ä¸€å±‚çš„å…¸å‹ç”¨é€”æ˜¯ä»€ä¹ˆï¼Ÿ

4. **Driver å’Œ Presenter å¦‚ä½•å®ç°è§£è€¦ï¼Ÿ**
   - æ·»åŠ æ–°çš„è¾“å…¥æºéœ€è¦ä¿®æ”¹ Presenter å—ï¼Ÿ

5. **AgentX å¦‚ä½•ä¸ PromptX é›†æˆï¼Ÿ**
   - ä½¿ç”¨ä»€ä¹ˆåè®®ï¼Ÿ

### å®è·µæ£€æŸ¥

ç¡®è®¤ä½ èƒ½å¤Ÿå®Œæˆä»¥ä¸‹ä»»åŠ¡ï¼š

- [ ] ä½¿ç”¨ NPX å¯åŠ¨ Portagent
- [ ] ä½¿ç”¨ Docker éƒ¨ç½² Portagent
- [ ] åˆ›å»ºä¸€ä¸ªåŸºæœ¬çš„ AgentX åº”ç”¨
- [ ] ç›‘å¬äº‹ä»¶å¹¶å¤„ç†
- [ ] é…ç½® MCP æœåŠ¡å™¨
- [ ] é›†æˆ PromptX å¹¶æ¿€æ´»è§’è‰²
- [ ] ä½¿ç”¨ recall/remember è¿›è¡Œè®°å¿†æ“ä½œ

---

## 7.6.5 ä¸å…¶ä»–ç« èŠ‚çš„å…³ç³»

```
ç¬¬äº”ç« ï¼šPromptXï¼ˆè®¤çŸ¥èƒ½åŠ›ï¼‰
    â”‚ æä¾›è§’è‰²ã€å·¥å…·ã€è®°å¿†
    â†“
ç¬¬å…­ç« ï¼šDeepractice æ–¹æ³•è®ºï¼ˆè®¾è®¡åŸåˆ™ï¼‰
    â”‚ 4P ç†è®ºã€çŠ¶æ€æœºã€PATEOAS
    â†“
ã€ç¬¬ä¸ƒç« ã€‘ï¼šAgentXï¼ˆå·¥ç¨‹å®ç°ï¼‰
    â”‚ äº‹ä»¶é©±åŠ¨ã€è¿è¡Œæ—¶
    â†“
ç¬¬å…«ç« ï¼šä¸»æµå¤šæ™ºèƒ½ä½“æ¡†æ¶ï¼ˆå¯¹æ¯”å­¦ä¹ ï¼‰
    â”‚ AutoGenã€AgentScopeã€CAMELã€LangGraph
    â†“
ç¬¬ä¹ç« ï¼šè®°å¿†ä¸æ£€ç´¢ï¼ˆæ·±å…¥ç†è§£ï¼‰
```

**å…³ç³»è¯´æ˜**ï¼š
- AgentX æ˜¯ PromptX çš„**è¿è¡Œæ—¶è½½ä½“**
- AgentX æ˜¯ Deepractice æ–¹æ³•è®ºçš„**å·¥ç¨‹å®ç°**
- ç¬¬å…«ç« å°†å¯¹æ¯” AgentX ä¸å…¶ä»–æ¡†æ¶çš„å¼‚åŒ

---

## 7.6.6 å¿«é€Ÿå‚è€ƒ

### å¿«é€Ÿå¯åŠ¨

```bash
# æ–¹å¼ä¸€ï¼šNPX
export ANTHROPIC_API_KEY=sk-ant-xxx
npx @agentxjs/portagent

# æ–¹å¼äºŒï¼šDocker
docker run -d -e ANTHROPIC_API_KEY=sk-ant-xxx -p 5200:5200 agentxjs/portagent
```

### ä»£ç æ¨¡æ¿

```typescript
import { createAgent } from '@agentxjs/runtime'

const agent = await createAgent({
  model: 'claude-sonnet-4-20250514',
  apiKey: process.env.ANTHROPIC_API_KEY,
  mcpServers: [
    { name: 'promptx', command: 'npx', args: ['-y', '@promptx/cli'] }
  ]
})

agent.on('text_delta', (e) => process.stdout.write(e.delta))
agent.on('thinking_start', () => console.log('ğŸ¤”'))
agent.on('thinking_end', () => console.log('âœ…'))

await agent.chat('ä½ å¥½')
```

### å…³é”® API

```typescript
// åˆ›å»ºæ™ºèƒ½ä½“
createAgent(config): Promise<Agent>

// Agent æ–¹æ³•
agent.chat(message): Promise<string>
agent.stream(message): AsyncGenerator<string>
agent.on(event, handler): void
agent.getMessages(): Promise<Message[]>
agent.destroy(): Promise<void>

// SystemBus æ–¹æ³•
bus.emit(type, data): void
bus.on(type, handler): void
bus.filter(predicate): Observable
```

---

## 7.6.7 ä¸‹ä¸€æ­¥å­¦ä¹ 

å®Œæˆæœ¬ç« åï¼Œå»ºè®®ï¼š

1. **åŠ¨æ‰‹å®è·µ**ï¼šä½¿ç”¨ AgentX æ„å»ºä¸€ä¸ªå®Œæ•´çš„æ™ºèƒ½ä½“åº”ç”¨
2. **é˜…è¯»æºç **ï¼šæ·±å…¥ç†è§£ AgentEngine çš„çŠ¶æ€æœºå®ç°
3. **å¯¹æ¯”å­¦ä¹ **ï¼šé˜…è¯»ç¬¬å…«ç« ï¼Œäº†è§£å…¶ä»–æ¡†æ¶çš„è®¾è®¡ç†å¿µ
4. **æ‰©å±•èƒ½åŠ›**ï¼šç»“åˆç¬¬ä¹ç« çš„è®°å¿†ç³»ç»Ÿï¼Œå¢å¼ºæ™ºèƒ½ä½“çš„é•¿æœŸè®°å¿†

---

## æœ¬ç« è¦ç‚¹æ€»ç»“

| ä¸»é¢˜ | æ ¸å¿ƒå†…å®¹ |
|-----|---------|
| **è®¾è®¡å“²å­¦** | äº‹ä»¶é©±åŠ¨ã€Mealy Machineã€åˆ†å±‚è§£è€¦ |
| **äº‹ä»¶æ¨¡å‹** | Stream â†’ State â†’ Message â†’ Turn |
| **æ ¸å¿ƒç»„ä»¶** | AgentEngineã€SystemBusã€Containerã€Environment |
| **è¿è¡Œæ—¶** | ç”Ÿå‘½å‘¨æœŸç®¡ç†ã€æŒä¹…åŒ–ã€ç›‘æ§ |
| **PromptX é›†æˆ** | MCP åè®®ã€è§’è‰²æ¿€æ´»ã€è®°å¿†ç®¡ç† |

---

**æ­å–œä½ å®Œæˆäº†ç¬¬ä¸ƒç« çš„å­¦ä¹ ï¼**

ä¸‹ä¸€ç« ï¼Œæˆ‘ä»¬å°†å­¦ä¹ ä¸»æµçš„å¤šæ™ºèƒ½ä½“æ¡†æ¶ï¼ŒåŒ…æ‹¬ AutoGenã€AgentScopeã€CAMEL å’Œ LangGraphï¼Œé€šè¿‡å¯¹æ¯”åŠ æ·±å¯¹æ™ºèƒ½ä½“æ¡†æ¶è®¾è®¡çš„ç†è§£ã€‚

---

[ä¸Šä¸€èŠ‚ï¼šä¸ PromptX é›†æˆ](7.5-ä¸PromptXé›†æˆ.md) | [è¿”å›ç›®å½•](README.md) | [ä¸‹ä¸€ç« ï¼šä¸»æµå¤šæ™ºèƒ½ä½“æ¡†æ¶](../chapter08/README.md)
