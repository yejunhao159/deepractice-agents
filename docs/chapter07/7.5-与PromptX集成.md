# 7.5 与 PromptX 集成

> 让 AgentX 拥有认知能力

在第五章中，我们学习了 PromptX 的认知系统——角色、工具和记忆。本节将介绍如何将这些能力集成到 AgentX 运行时中。

---

## 7.5.1 集成概述

### AgentX + PromptX = 完整的智能体

```
┌─────────────────────────────────────────────────────────┐
│                    AgentX 运行时                         │
│  ┌──────────────────────────────────────────────────┐  │
│  │                 事件驱动引擎                       │  │
│  │  AgentEngine + SystemBus + Container              │  │
│  └──────────────────────────────────────────────────┘  │
│                          │                              │
│                          │ MCP 协议                     │
│                          ▼                              │
│  ┌──────────────────────────────────────────────────┐  │
│  │                PromptX 认知层                     │  │
│  │  ┌─────────┐  ┌─────────┐  ┌─────────────────┐  │  │
│  │  │ Nuwa    │  │ Luban   │  │ Engram Memory   │  │  │
│  │  │ 角色系统 │  │ 工具系统 │  │ 记忆网络        │  │  │
│  │  └─────────┘  └─────────┘  └─────────────────┘  │  │
│  └──────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────┘
```

### 集成方式

AgentX 通过 MCP 协议与 PromptX 集成：

```typescript
import { createAgent } from '@agentxjs/runtime'

const agent = await createAgent({
  model: 'claude-sonnet-4-20250514',
  apiKey: process.env.ANTHROPIC_API_KEY,

  // 配置 PromptX MCP 服务器
  mcpServers: [
    {
      name: 'promptx',
      command: 'npx',
      args: ['-y', '@anthropic-ai/mcp-server-promptx']
    }
  ]
})
```

---

## 7.5.2 角色激活

### 使用 action 工具

PromptX 提供 `action` 工具来激活角色：

```typescript
// 让 AI 激活角色
await agent.chat('使用 action 工具激活 writer 角色')

// AI 会调用 action 工具
// tool_call: {
//   name: 'mcp__promptx__action',
//   input: { role: 'writer' }
// }

// 激活后，AI 获得角色的知识、原则和能力
await agent.chat('帮我写一篇关于 AI 发展的文章')
```

### 角色切换

```typescript
// 初始化为通用助手
await agent.chat('你好')

// 切换到程序员角色
await agent.chat('我需要写代码，请激活 coder 角色')

// 切换到产品经理角色
await agent.chat('现在需要分析需求，切换到 product-manager 角色')
```

### 自定义角色

使用 Nuwa 创建的角色也可以激活：

```typescript
// 假设你用 Nuwa 创建了一个 "frontend-expert" 角色
await agent.chat('激活 frontend-expert 角色')

// 使用角色能力
await agent.chat('帮我优化这个 React 组件的性能')
```

### 监听角色激活事件

```typescript
agent.on('tool_start', (event) => {
  if (event.name === 'mcp__promptx__action') {
    console.log(`正在激活角色: ${event.input.role}`)
  }
})

agent.on('tool_end', (event) => {
  if (event.name === 'mcp__promptx__action') {
    console.log(`角色已激活: ${event.output.role}`)
  }
})
```

---

## 7.5.3 工具调用

### PromptX 工具系统

PromptX 的 Luban 系统创建的工具通过 `toolx` 接口调用：

```typescript
// AI 可以调用 PromptX 工具
await agent.chat('使用 toolx 读取 README.md 文件')

// tool_call: {
//   name: 'mcp__promptx__toolx',
//   input: {
//     yaml: `
//       tool: tool://filesystem
//       mode: execute
//       parameters:
//         action: read
//         path: ./README.md
//     `
//   }
// }
```

### 工具发现

```typescript
// 让 AI 发现可用工具
await agent.chat('使用 discover 工具查看所有可用的工具')

// AI 调用 discover
// 返回：
// - tool://filesystem: 文件操作
// - tool://pdf-reader: PDF 读取
// - tool://excel-tool: Excel 处理
// ...
```

### 组合使用

```typescript
// AI 可以组合多个工具完成任务
await agent.chat(`
  请帮我完成以下任务：
  1. 读取 data.xlsx 文件
  2. 分析其中的销售数据
  3. 生成分析报告并保存为 report.md
`)

// AI 会按顺序调用:
// 1. toolx -> excel-tool (read)
// 2. 分析数据
// 3. toolx -> filesystem (write)
```

### 工具调用事件

```typescript
agent.on('tool_start', (event) => {
  console.log(`工具调用: ${event.name}`)
  console.log(`输入: ${JSON.stringify(event.input)}`)
})

agent.on('tool_end', (event) => {
  console.log(`工具返回: ${JSON.stringify(event.output)}`)
})

agent.on('tool_error', (event) => {
  console.error(`工具错误: ${event.error.message}`)
})
```

---

## 7.5.4 记忆管理

### recall：记忆检索

```typescript
// 让 AI 回忆相关知识
await agent.chat('使用 recall 工具回忆关于用户偏好的信息')

// tool_call: {
//   name: 'mcp__promptx__recall',
//   input: {
//     role: 'assistant',
//     query: '用户偏好',
//     mode: 'balanced'
//   }
// }

// 返回记忆网络中的相关信息
```

### remember：记忆存储

```typescript
// 让 AI 保存重要信息
await agent.chat('记住：用户喜欢使用 TypeScript 和 React')

// AI 调用 remember 工具
// tool_call: {
//   name: 'mcp__promptx__remember',
//   input: {
//     role: 'assistant',
//     engrams: [{
//       content: '用户偏好 TypeScript 和 React 技术栈',
//       schema: '用户 偏好 TypeScript React',
//       strength: 0.8,
//       type: 'LINK'
//     }]
//   }
// }
```

### 认知循环

AgentX 支持完整的认知循环：

```typescript
// 1. 用户提问
await agent.chat('帮我优化这段代码')

// 2. AI 先回忆相关知识
// recall -> 获取用户偏好、历史经验

// 3. AI 思考并回答
// 结合记忆和当前问题给出答案

// 4. AI 保存新经验
// remember -> 保存本次优化的经验

// 这形成了：recall → 思考 → remember 的认知循环
```

### 记忆事件

```typescript
agent.on('tool_end', (event) => {
  if (event.name === 'mcp__promptx__recall') {
    const memories = event.output.memories
    console.log(`回忆到 ${memories.length} 条相关记忆`)
  }

  if (event.name === 'mcp__promptx__remember') {
    console.log(`保存了 ${event.input.engrams.length} 条新记忆`)
  }
})
```

---

## 7.5.5 完整集成示例

### 项目配置

```typescript
// src/config.ts
export const config = {
  agent: {
    model: 'claude-sonnet-4-20250514',
    apiKey: process.env.ANTHROPIC_API_KEY
  },
  promptx: {
    defaultRole: 'assistant'
  }
}
```

### 创建智能体

```typescript
// src/agent.ts
import { createAgent } from '@agentxjs/runtime'
import { config } from './config'

export async function createPromptXAgent() {
  const agent = await createAgent({
    ...config.agent,

    // PromptX MCP 服务器
    mcpServers: [
      {
        name: 'promptx',
        command: 'npx',
        args: ['-y', '@promptx/cli']
      }
    ],

    // 系统提示词：引导 AI 使用 PromptX
    systemPrompt: `你是一个智能助手，可以使用以下 PromptX 工具：

1. action: 激活专业角色（如 writer, coder, product-manager）
2. recall: 检索记忆网络中的相关知识
3. remember: 保存重要信息到记忆网络
4. discover: 发现可用的角色和工具
5. toolx: 调用 PromptX 工具

在回答问题前，先思考是否需要：
- 激活专业角色来提供更专业的帮助
- 回忆相关的历史信息
- 使用工具来完成任务

在对话结束时，考虑保存有价值的新知识。`
  })

  return agent
}
```

### 事件处理

```typescript
// src/events.ts
import type { Agent } from '@agentxjs/runtime'

export function setupEventHandlers(agent: Agent) {
  // 思考状态
  agent.on('thinking_start', () => {
    console.log('\n🤔 思考中...')
  })

  agent.on('thinking_end', (event) => {
    console.log(`\n✅ 完成 (${event.duration}ms)`)
  })

  // 文本流
  agent.on('text_delta', (event) => {
    process.stdout.write(event.delta)
  })

  // 工具调用
  agent.on('tool_start', (event) => {
    const toolName = event.name.replace('mcp__promptx__', '')
    console.log(`\n🔧 ${toolName}: ${JSON.stringify(event.input)}`)
  })

  agent.on('tool_end', (event) => {
    console.log(`📦 结果已返回`)
  })

  // 错误处理
  agent.on('error', (event) => {
    console.error(`\n❌ 错误: ${event.message}`)
  })
}
```

### 主程序

```typescript
// src/main.ts
import { createPromptXAgent } from './agent'
import { setupEventHandlers } from './events'
import * as readline from 'readline'

async function main() {
  console.log('🚀 启动 AgentX + PromptX 智能体...\n')

  // 创建智能体
  const agent = await createPromptXAgent()

  // 设置事件处理
  setupEventHandlers(agent)

  // 创建命令行接口
  const rl = readline.createInterface({
    input: process.stdin,
    output: process.stdout
  })

  console.log('智能体已就绪！输入消息开始对话 (输入 exit 退出)\n')

  const prompt = () => {
    rl.question('> ', async (input) => {
      if (input.toLowerCase() === 'exit') {
        await agent.destroy()
        rl.close()
        process.exit(0)
      }

      await agent.chat(input)
      prompt()
    })
  }

  prompt()
}

main().catch(console.error)
```

### 运行

```bash
# 安装依赖
pnpm add @agentxjs/runtime

# 设置环境变量
export ANTHROPIC_API_KEY=sk-ant-xxx

# 运行
npx tsx src/main.ts
```

### 使用示例

```
🚀 启动 AgentX + PromptX 智能体...

智能体已就绪！输入消息开始对话 (输入 exit 退出)

> 你好，我需要帮助优化 React 代码

🤔 思考中...
🔧 action: {"role":"coder"}
📦 结果已返回

你好！我已经激活了 coder 角色。请把你的 React 代码发给我，我会帮你分析并提供优化建议。

✅ 完成 (2500ms)

> 帮我回忆一下之前讨论过的代码规范

🤔 思考中...
🔧 recall: {"role":"coder","query":"代码规范","mode":"balanced"}
📦 结果已返回

根据我的记忆，我们之前讨论过以下代码规范：
1. 组件使用函数式写法 + Hooks
2. 状态管理使用 Zustand
3. 样式使用 Tailwind CSS
...

✅ 完成 (1800ms)

> exit
```

---

## 本节要点

1. **MCP 集成**：通过 MCP 协议将 PromptX 连接到 AgentX
2. **角色激活**：使用 action 工具激活专业角色
3. **工具调用**：使用 toolx 调用 PromptX 工具系统
4. **记忆管理**：recall 检索 + remember 存储的认知循环
5. **事件监听**：通过事件追踪 PromptX 工具的使用

---

## 下一步

现在你已经掌握了 AgentX 与 PromptX 的集成方式。下一节将总结本章的核心内容，并提供学习检查清单。

---

[上一节：运行时系统](7.4-运行时系统.md) | [下一节：本章小结](7.6-本章小结.md)
